#!/usr/bin/env node
module.exports=function(e){var o={};function r(t){if(o[t])return o[t].exports;var n=o[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=o,r.d=function(e,o,t){r.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:t})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,o){if(1&o&&(e=r(e)),8&o)return e;if(4&o&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(r.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&o&&"string"!=typeof e)for(var n in e)r.d(t,n,function(o){return e[o]}.bind(null,n));return t},r.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(o,"a",o),o},r.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},r.p="",r(r.s=25)}([function(e,o){e.exports=require("express")},function(e,o){e.exports=require("request-promise")},function(e,o){e.exports=require("uuid/v1")},function(e,o,r){"use strict";var t={appTitle:"Blocktron Node",defaultAppPort:3e3,blocktronNodeId:r(2)().split("-").join(""),rewardSenderAddress:"00BLOCKTRON",rewardValue:12.5,difficulty:4,mineRate:4e3};e.exports=t},function(e,o){e.exports=require("http")},function(e,o){e.exports=require("debug")},function(e,o,r){"use strict";e.exports=function(e,o,r){!function(){try{o.header("Access-Control-Allow-Origin","*"),o.header("Access-Control-Allow-Methods","GET,PUT,POST,DELETE"),o.header("Access-Control-Allow-Headers","Content-Type")}catch(e){log.error("CORS setup failed due to: "+e)}}(),function(){try{o.append("x-powered-by","blocktron"),o.append("x-blocktron-Accept-Charset","UTF-8"),o.append("x-blocktron-Accept-Language","en"),o.append("x-blocktron-response-timestamp",""+Date.now()),o.append("x-blocktron-host-uuid",""+_bt_config.blocktronNodeId)}catch(e){log.error("Header appendage failed due to: "+e)}}(),r()}},function(e,o,r){"use strict";var t=r(0).Router();t.use(r(6)),e.exports=t},function(e,o,r){"use strict";var t=r(0).Router(),n=r(1);t.get("/",function(e,o,r){var t=[];blocktron.networkNodes.forEach(function(e){var o={uri:e+"/blockchain",method:"GET",json:!0};t.push(n(o))}),Promise.all(t).then(function(e){var r=blocktron.chain.length,t=null,n=null;if(e.forEach(function(e){e.chain.length>r&&(r=e.chain.length,t=e.chain,n=e.pendingTransactions)}),!t||t&&!blocktron.isChainValid(t)){log.error("Current blockchain has not been replaced"),o.status(200);var s={status:"Not Modified",code:o.statusCode,message:"Current blockchain has not been replaced",blockchain:blocktron.chain};o.json(s)}else if(t&&blocktron.isChainValid(t)){blocktron.chain=t,blocktron.pendingTransactions=n,o.status(201);var a={status:"Chain replaced",code:o.statusCode,message:"Current blockchain has been replaced",blockchain:blocktron.chain};o.json(a)}}).catch(function(e){log.error("Consensus check failed due to: "+e)})}),e.exports=t},function(e,o,r){"use strict";var t=r(0).Router();t.post("/",function(e,o,r){if(e&&e.body&&e.body.newBlock){var t=e.body.newBlock,n=blocktron.getLastBlock(),s=n.hash===t.previousHash,a=n.index+1===t.index;if(s&&a){blocktron.chain.push(t),blocktron.pendingTransactions=[],o.status(201);var i={status:"success",code:o.statusCode,message:"New block received and accepted",blockData:t};o.json(i)}else{o.status(400);var c={status:"Bad request",code:o.statusCode,message:"Invalid block data"};o.json(c)}}else{log.error("Block data missing"),o.status(400);var u={status:"Bad request",code:o.statusCode,message:"Invalid data type or missing data"};o.json(u)}}),e.exports=t},function(e,o,r){"use strict";var t=r(0).Router(),n=r(1);t.post("/",function(e,o,r){e&&e.body&&e.body.amount&&e.body.sender&&e.body.receiver||log.error("Cannot create a transaction without required parameters");var t=blocktron.createNewTransaction(e.body.amount,e.body.sender,e.body.receiver);blocktron.addTransactionToPendingTransaction(t);var s=[];blocktron.networkNodes.forEach(function(e){var o={uri:e+"/transaction",method:"POST",body:t,json:!0};s.push(n(o))}),Promise.all(s).then(function(e){o.status(201);var r={status:"success",code:o.statusCode,message:"Transaction created and broadcasted successfully"};o.json(r)}).catch(function(e){log.error("Transaction broadcast failed due to: "+e)})}),e.exports=t},function(e,o,r){"use strict";var t=r(0).Router();t.post("/",function(e,o,r){if(e.body&&e.body.allNetworkNodes){e.body.allNetworkNodes.forEach(function(e){var o=blocktron.currentNodeUrl!==e;blocktron.isNewNode(e)&&o?blocktron.networkNodes.push(e):log.error("Given url: "+e+" rejected, it is already present or is a conflicting value")}),o.status(201);var t={status:"success",code:o.statusCode,message:"Bulk registration of nodes successful"};o.json(t)}else{log.error("Bad request, given request body is either empty or contains invalid data"),o.status(400);var n={status:"Bad request",code:o.statusCode,message:"Invalid data type or missing data"};o.json(n)}}),e.exports=t},function(e,o,r){"use strict";var t=r(0).Router();t.post("/",function(e,o,r){var t=e.body.newNodeUrl,n=blocktron.currentNodeUrl!==t;blocktron.isNewNode(t)&&n?blocktron.networkNodes.push(t):log.error("Given url: "+t+" rejected, it is already present or is a conflicting value"),o.status(201);var s={status:"success",code:o.statusCode,message:"New node registered successfully"};o.json(s)}),e.exports=t},function(e,o,r){"use strict";var t=r(0).Router(),n=r(1);t.post("/",function(e,o,r){var t=e.body.newNodeUrl,s=blocktron.currentNodeUrl!==t;if(blocktron.isNewNode(t)&&s){blocktron.networkNodes.push(t);var a=[];blocktron.networkNodes.forEach(function(e){var o={uri:e+"/registerNode",method:"POST",body:{newNodeUrl:t},json:!0};a.push(n(o))}),Promise.all(a).then(function(e){var o={uri:t+"/registerNodesBulk",method:"POST",body:{allNetworkNodes:[].concat(function(e){if(Array.isArray(e)){for(var o=0,r=Array(e.length);o<e.length;o++)r[o]=e[o];return r}return Array.from(e)}(blocktron.networkNodes),[blocktron.currentNodeUrl])},json:!0};return n(o)}).then(function(e){o.status(201);var r={status:"success",code:o.statusCode,message:"New nodes registered with the network"};o.json(r)}).catch(function(e){log.error("Nodes registration failed due to: "+e),o.status(409);var r={status:"resource conflict",code:o.statusCode,message:"Given node url: "+t+", is a conflicting value"};o.json(r)})}else{o.status(409);var i={status:"resource conflict",code:o.statusCode,message:"Given node url: "+t+", is already present in registry or is a conflicting value"};o.json(i)}}),e.exports=t},function(e,o,r){"use strict";var t=r(0).Router(),n=r(1);t.get("/",function(e,o,r){var t=blocktron.getLastBlock(),s=t.hash,a={transactions:blocktron.pendingTransactions,index:t.index+1},i=blocktron.proofOfWork(s,a),c=blocktron.hashBlock(s,a,i),u=blocktron.createNewBlock(i,s,c),l=[];blocktron.networkNodes.forEach(function(e){var o={uri:e+"/receiveNewBlock",method:"POST",body:{newBlock:u},json:!0};l.push(n(o))}),Promise.all(l).then(function(e){var o={uri:blocktron.currentNodeUrl+"/transaction/broadcast",method:"POST",body:{amount:_bt_config.rewardValue,sender:_bt_config.rewardSenderAddress,receiver:_bt_config.blocktronNodeId},json:!0};return n(o)}).then(function(e){o.status(201);var r={status:"success",code:o.statusCode,message:"New block mined and broadcasted successfully",blockData:u};o.json(r)}).catch(function(e){log.error("Block mine and broadcast failed due to: "+e)})}),e.exports=t},function(e,o,r){"use strict";var t=r(0).Router();t.post("/",function(e,o,r){if(e.body){var t=blocktron.addTransactionToPendingTransaction(e.body),n={status:"success",code:o.statusCode,message:"Transaction will be added to the block: "+t};o.json(n)}else log.error("Cannot create a transaction without required parameter")}),e.exports=t},function(e,o,r){"use strict";var t=r(0).Router();t.get("/",function(e,o,r){o.json(blocktron)}),e.exports=t},function(e,o,r){"use strict";var t=r(0).Router();t.get("/",function(e,o,r){var t={message:"Blocktron Node is running",port:port,status_code:o.statusCode,configuration:{process_title:process.title,process_pid:process.pid,memory:{resident_set_size:process.memoryUsage().rss/1024/1024*100/100+" MB",heap_total:process.memoryUsage().heapTotal/1024/1024*100/100+" MB",heap_used:process.memoryUsage().heapUsed/1024/1024*100/100+" MB",external:process.memoryUsage().external/1024/1024*100/100+" MB"},node_id:_bt_config.blocktronNodeId,node_address:process.argv[3]?process.argv[3]:"http://127.0.0.1:"+port,environment:env,os:process.platform,cpu_arch:process.arch,process_versions:{node_version:process.versions.node,v8_version:process.versions.v8}}};o.json(t)}),e.exports=t},function(e,o){e.exports=require("blocktron-lib")},function(e,o,r){"use strict";var t=function(){function e(e,o){for(var r=0;r<o.length;r++){var t=o[r];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(o,r,t){return r&&e(o.prototype,r),t&&e(o,t),o}}();var n=r(18),s=r(2),a=void 0;a=process.argv[3]?process.argv[3]:"";var i=r(3),c=function(e){function o(e,r){!function(e,o){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}(this,o);var t=function(e,o){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!o||"object"!=typeof o&&"function"!=typeof o?e:o}(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e,r));return t.currentNodeUrl=a,t.networkNodes=[],t}return function(e,o){if("function"!=typeof o&&null!==o)throw new TypeError("Super expression must either be null or a function, not "+typeof o);e.prototype=Object.create(o&&o.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),o&&(Object.setPrototypeOf?Object.setPrototypeOf(e,o):e.__proto__=o)}(o,n),t(o,[{key:"isNewNode",value:function(e){return-1===this.networkNodes.indexOf(e)}},{key:"createNewTransaction",value:function(e,o,r){return e=e||function(){throw new Error("Amount required")}(),o=o||function(){throw new Error("Sender required")}(),r=r||function(){throw new Error("receiver required")}(),{transactionId:s().split("-").join(""),amount:e,sender:o,receiver:r}}},{key:"addTransactionToPendingTransaction",value:function(e){if(e)return this.pendingTransactions.push(e),this.getLastBlock().index+1;log.error("Transaction data required")}},{key:"isChainValid",value:function(e){if(e){for(var o=!0,r=1;r<e.length;r++){var t=e[r],n=e[r-1];this.hashBlock(n.hash,{transactions:t.transactions,index:t.index},t.nonce).substring(0,i.difficulty)!=="0".repeat(i.difficulty)&&(o=!1),t.previousHash!==n.hash&&(o=!1)}var s=e[0],a=1===s.nonce,c="0"===s.previousHash,u="0"===s.hash,l=0===s.transactions.length;return a&&c&&u&&l||(o=!1),o}log.error("Blockchain data required")}}]),o}();e.exports=c},function(e,o,r){"use strict";e.exports={colorize:!0,crlf:!0,errorLikeObjectKeys:["err","error"],errorProps:"",levelFirst:!1,localTime:!1,messageKey:"msg",translateTime:!1}},function(e,o,r){"use strict";var t={safe:!0,name:"blocktron",timestamp:!0,slowtime:!1,level:"info",messageKey:"msg",prettyPrint:r(20),enabled:!0};e.exports=t},function(e,o){e.exports=require("pino")},function(e,o){e.exports=require("http-errors")},function(e,o,r){"use strict";var t=r(3);global._bt_config=t;var n="production";global.env=n,process.title=t.appTitle;var s=r(23),a=r(0),i=r(22)(r(21));global.log=i;var c=new(r(19));global.blocktron=c;var u=r(17),l=r(16),d=r(15),f=r(14),p=r(13),b=r(12),v=r(11),h=r(10),g=r(9),k=r(8);i.info("Blocktron routes initialized");var y=a();i.info("Blocktron initialized and running in "+n+" mode"),y.disable("x-powered-by"),y.use(a.json()),y.use(a.urlencoded({extended:!1})),i.info("Blocktron application middlewares initialized"),y.use(r(7)),i.info("Blocktron custom middlewares initialized"),y.use("/",u),y.use("/docs",a.static("docs")),y.use("/blockchain",l),y.use("/transaction",d),y.use("/mine",f),y.use("/registerAndBroadcastNode",p),y.use("/registerNode",b),y.use("/registerNodesBulk",v),y.use("/transaction/broadcast",h),y.use("/receiveNewBlock",g),y.use("/consensus",k),i.info("Blocktron routes chained to middlewares"),y.use(function(e,o,r){i.error("Error caught"),r(s(404))}),y.use(function(e,o,r,t){r.status(e.status||500);var n={status:e.status||500,message:e.message};i.error(o,r),r.json(n)}),e.exports=y},function(e,o,r){"use strict";var t=r(24),n=r(5)("blocktron-node:server"),s=r(4),a=function(e){var o=parseInt(e,10);if(isNaN(o))return e;if(o>=0)return o;return!1}(process.argv[2]||_bt_config.defaultAppPort);global.port=a,t.set("port",a);var i=s.createServer(t);i.listen(a,function(){log.info("Blocktron is running on port: "+a)}),i.on("error",function(e){if("listen"!==e.syscall)throw e;var o="string"==typeof a?"Pipe "+a:"Port "+a;switch(e.code){case"EACCES":console.error(o+" requires elevated privileges"),process.exit(1);break;case"EADDRINUSE":console.error(o+" is already in use"),process.exit(1);break;default:throw e}}),i.on("listening",function(){var e=i.address(),o="string"==typeof e?"pipe "+e:"port "+e.port;n("Listening on "+o)})}]);
//# sourceMappingURL=blocktron_node.min.js.map